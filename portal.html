<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>E & C Courier Portal</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffd700">
<link rel="icon" type="image/png" href="icon-512.png">

<style>
  :root { 
    --accent: #ffd700;       
    --bg: #222222; 
    --card: #141414; 
    --text: #e0e0e0; 
    --input-bg: #1e1e1e;
    --border: #333333;
    --placeholder: #777777;
    --success: #00b32d;
  }

  body.light-mode {
    --bg: #f0f2f5; 
    --card: #ffffff;
    --text: #000000;
    --input-bg: #ffffff;
    --border: #cccccc;
    --placeholder: #555555;
  }

  body.light-mode h1 {
    background: none;
    color: #000000;
    -webkit-text-fill-color: #000000;
  }

  body.light-mode .section-title {
    color: #b39700; /* Darker yellow so it can be seen clearly on white */
  }

  body.light-mode button[type="submit"] {
    background: #ffffff;
    color: #000000;
    border-color: #00b32d;
  }

  body.light-mode .header-wrap {
    background: #ffffff;
  }

  body.light-mode #auth-overlay p, body.light-mode #auth-overlay h2 {
    color: #000000 !important;
  }

  body.light-mode .modal-content { background: #ffffff; color: #000000; }
  body.light-mode .btn-cancel { background: #eee; color: #333; border-color: #ccc; }
  body.light-mode button[onclick="customerSignUp()"] { background: var(--accent) !important; color: #000 !important; border: none !important; }
  body.light-mode input:focus, body.light-mode textarea:focus, body.light-mode select:focus { background: #ffffff !important; }

  @keyframes fadeInPage {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes glow-pulse {
    0% { box-shadow: 0 0 2px rgba(255, 215, 0, 0.1); border-color: var(--border); }
    50% { box-shadow: 0 0 8px rgba(255, 215, 0, 0.3); border-color: var(--accent); }
    100% { box-shadow: 0 0 2px rgba(255, 215, 0, 0.1); border-color: var(--border); }
  }

  body { 
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
    background-color: var(--bg); 
    color: var(--text);
    margin: 0; 
    display: flex; 
    justify-content: center; 
    align-items: flex-start;
    padding: 20px 15px; 
    box-sizing: border-box; 
    min-height: 100vh;
  }

  .container { 
    background: var(--card); 
    width: 100%; 
    max-width: 600px; 
    border-radius: 8px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
    border: 1px solid var(--border);
    animation: fadeInPage 0.5s ease-out;
    overflow: hidden;
    position: relative;
    margin-top: 10px;
  }

  /* Header Styling */
  .header-wrap { 
    background: #000000;
    border-bottom: 2px solid var(--accent);
    padding: 25px 20px;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 15px; 
  }

  .header-wrap img { 
    height: 35px; 
    width: auto; 
    filter: drop-shadow(0 0 2px var(--accent));
  }
  
  h1 { 
    color: var(--text); 
    margin: 0; 
    font-size: 22px; 
    font-weight: 800; 
    text-transform: uppercase;
    letter-spacing: 1px;
    background: linear-gradient(to right, var(--accent) 0%, #fff 50%, var(--accent) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    background-size: 200% auto;
    animation: text-shine 4s linear infinite;
  }

  @keyframes text-shine { to { background-position: 200% center; } }

  form { padding: 25px; }

  /* Section Dividers */
  .section-title {
    color: var(--accent);
    font-size: 13px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin: 20px 0 10px 0;
    display: flex;
    align-items: center;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
    margin-left: 10px;
  }
  .section-title:first-of-type { margin-top: 0; }
  
  /* Input Styling */
  .input-group { margin-bottom: 12px; }
  
  label {
    display: block;
    font-size: 13px;
    font-weight: 700;
    color: #888;
    margin-bottom: 5px;
    margin-left: 2px;
  }
  
  .required-mark { color: var(--accent); margin-left: 2px; }

  input, textarea, select { 
    width: 100%; 
    padding: 15px 16px; 
    background: var(--input-bg); 
    border: 1px solid var(--border); 
    color: var(--text); 
    border-radius: 6px; 
    font-size: 17px; 
    box-sizing: border-box; 
    transition: all 0.2s;
    font-family: inherit;
  }

  input:focus, textarea:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 8px rgba(255, 215, 0, 0.15);
    background: #252525;
  }

  ::placeholder { color: var(--placeholder); font-size: 16px; }

  /* Layout Utilities */
  .flex-row { 
    display: flex; 
    gap: 12px; 
  }
  
  @media (max-width: 500px) {
    .flex-row { flex-direction: column; gap: 12px; }
  }

  /* Button Styling */
  button[type="submit"] { 
    width: 100%; 
    margin-top: 25px;
    padding: 20px;
    background: #1c1c1c;
    color: var(--text);
    font-weight: 800;
    border: 1px solid var(--border);
    border-bottom: 3px solid var(--accent);
    cursor: pointer;
    border-radius: 6px;
    text-transform: uppercase;
    font-size: 18px;
    letter-spacing: 1.5px;
    transition: all 0.2s ease;
  }

  button[type="submit"]:hover {
    background: #252525;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  
  button[type="submit"]:active { transform: translateY(1px); }

  /* Success Message */
  #thanksMessage { 
    display: none;
    padding: 40px 30px; 
    text-align: center;
    animation: fadeInPage 0.4s ease;
  }
  
  .success-icon {
    font-size: 40px;
    color: var(--success);
    margin-bottom: 15px;
    display: block;
  }
  
  .success-btn {
    background: var(--accent) !important;
    color: #000 !important;
    border: none !important;
    font-weight: 900 !important;
  }

  /* Modal Styling for Map Picker */
  .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(2px); }
  .modal-content { background: var(--card); margin: 5% auto; padding: 30px; width: 90%; max-width: 550px; border: 1px solid var(--accent); color: var(--text); border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); box-sizing: border-box; }
  .btn-cancel { background:#222; color:#ccc; border:1px solid #333; padding:12px; font-weight:700; cursor:pointer; font-size:13px; border-radius:4px; }
  .btn-save { background:var(--success); color:#000; border:none; padding:12px; font-weight:700; text-transform:uppercase; cursor:pointer; font-size:13px; border-radius:4px; }

</style>
</head>
<body class="light-mode">

<div id="auth-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh; overflow-y: auto; background: var(--bg); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; box-sizing: border-box;">
  
  <div style="max-width: 600px; width: 100%; text-align: center; margin-bottom: 30px;">
    <img src="icon2.png" alt="E&C Logo" style="height: 60px; margin-bottom: 15px; filter: drop-shadow(0 0 5px var(--accent)); cursor: pointer;" onclick="toggleTheme()" onerror="this.style.display='none'">
    <h1 style="color: var(--accent); font-size: 26px; margin: 0 0 10px 0; text-transform: uppercase;">E&C Courier</h1>
    <p style="color: #e0e0e0; font-size: 15px; margin-bottom: 15px; line-height: 1.5;">
      Request local courier pickups and deliveries quickly and securely.
    </p>
    <p style="color: #aaa; font-size: 13px; margin-bottom: 20px; line-height: 1.5;">
      <strong>Data Usage:</strong> We collect your email, phone, and address strictly to process dispatches at your request.
    </p>
    <a href="https://app.eandccourier.ca/privacy" target="_blank" style="background: var(--accent); color: #000; padding: 10px 20px; border-radius: 5px; font-weight: bold; text-decoration: none; display: inline-block; font-size: 14px;">Privacy Policy & Terms</a>
  </div>

  <div class="container" style="padding: 30px; text-align: center; margin-top: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.8);">
    <h2 style="color: #fff; margin-top: 0; margin-bottom: 20px; font-weight: 800; text-transform: uppercase; font-size: 18px;">Account Login</h2>
    
    <div class="input-group" style="text-align: left; margin-bottom: 15px;">
      <input type="email" id="auth-email" placeholder="Email Address" required>
    </div>
    <div class="input-group" style="text-align: left; margin-bottom: 25px;">
      <input type="password" id="auth-password" placeholder="Password" required>
    </div>
    
    <button type="button" onclick="customerLogin()" style="width: 100%; padding: 16px; background: var(--accent); color: #000; font-weight: 800; border: none; border-radius: 6px; cursor: pointer; text-transform: uppercase; margin-bottom: 12px; font-size: 16px;">Login</button>
    <button type="button" onclick="customerSignUp()" style="width: 100%; padding: 16px; background: #1c1c1c; color: var(--text); font-weight: 800; border: 1px solid var(--border); border-bottom: 3px solid var(--accent); border-radius: 6px; cursor: pointer; text-transform: uppercase; margin-bottom: 20px; font-size: 16px; transition: all 0.2s;">Create Account</button>
    <button type="button" onclick="googleSignIn()" style="width: 100%; padding: 12px; background: #ffffff; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3); transition: background-color 0.2s;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20px" height="20px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.519-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg><span style="font-family: 'Roboto', sans-serif; font-size: 14px; font-weight: 500; color: #3c4043;">Sign in with Google</span></button>
    
    <a href="#" onclick="forgotPassword(); return false;" style="color: var(--placeholder); font-size: 13px; text-decoration: underline;">Forgot Password?</a>
  </div>
</div>

<div class="container" id="main-app-container" style="display: none;">
  <div class="header-wrap" style="flex-direction: column;">
    <button id="installAppBtn" style="display:none; background:var(--accent); color:#000; border:none; padding:10px 20px; font-weight:900; border-radius:6px; margin-bottom:15px; cursor:pointer; font-size:14px; text-transform:uppercase;">Install App</button>
    <div style="display:flex; justify-content: space-between; width: 100%; align-items: center;">
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="icon2.png" alt="E&C Logo" style="cursor: pointer;" onclick="toggleTheme()" onerror="this.style.display='none'"> 
            <h1>Request Pickup Now</h1>
        </div>
        
    </div>
  </div>

  <form id="pickupForm">
    
    <div class="section-title">Pickup Details</div>
    
    <div class="input-group">
      <label>Business / Contact Name <span class="required-mark">*</span></label>
      <input type="text" name="name" placeholder="Who are we picking up from?" required autocomplete="organization">
    </div>

    <div class="flex-row">
      <div class="input-group" style="flex: 2; position: relative;">
        <label>Pickup Address <span class="required-mark">*</span></label>
        <input type="text" id="f-pickup" name="pickup_location" placeholder="Street Address" required autocomplete="street-address" style="padding-right: 40px;">
        <button style="position: absolute; right: 10px; bottom: 15px; background: transparent; border: none; font-size: 16px; cursor: pointer; padding: 0;" onclick="openLocationPicker('pickup')" type="button">üìç</button>
      </div>
      <div class="input-group" style="flex: 1;">
        <label>City <span class="required-mark">*</span></label>
        <input type="text" name="city" placeholder="City" required autocomplete="address-level2">
      </div>
    </div>

    <div class="flex-row">
      <div class="input-group" style="flex: 1;">
        <label>Email <span class="required-mark">*</span></label>
        <input type="email" name="customer_email" placeholder="notifications@example.com" required autocomplete="email">
      </div>
      <div class="input-group" style="flex: 1;">
        <label>Phone Number <span class="required-mark">*</span></label>
        <input type="tel" name="customer_phone" placeholder="(204) 555-0123" required autocomplete="tel" oninput="formatPhone(this)">
      </div>
    </div>

    <div class="section-title">Delivery Details</div>

    <div class="input-group">
      <label>Delivery Name <span class="required-mark">*</span></label>
      <input type="text" name="delivery_name" placeholder="Business or Contact Name" required>
    </div>

    <div class="flex-row">
      <div class="input-group" style="flex: 2; position: relative;">
        <label>Delivery Address <span class="required-mark">*</span></label>
        <input type="text" id="f-drop-address" name="destination" placeholder="Street Address" required style="padding-right: 40px;">
        <button style="position: absolute; right: 10px; bottom: 15px; background: transparent; border: none; font-size: 16px; cursor: pointer; padding: 0;" onclick="openLocationPicker('drop')" type="button">üìç</button>
      </div>
      <div class="input-group" style="flex: 1;">
        <label>City <span class="required-mark">*</span></label>
        <input type="text" name="drop_city" placeholder="City" required>
      </div>
    </div>

    <div class="section-title">Cargo & Information</div>

    <div class="input-group">
      <label>Packages / Items / Dimensions <span class="required-mark">*</span></label>
      <input type="text" name="package_details" placeholder="e.g. 2 Boxes (12x12x12), 1 Skid" required>
    </div>

    <div class="input-group">
      <label>PO Number / Reference</label>
      <input type="text" name="po_number" placeholder="Optional">
    </div>

    <div class="input-group">
      <label>Driver Notes / Instructions</label>
      <textarea name="other_info" rows="3" placeholder="Gate codes, specific door numbers, hours, etc."></textarea>
    </div>

    <button type="submit" id="submitBtn">Submit Request</button>
    <button type="button" onclick="firebase.auth().signOut()" style="background:transparent; border:1px solid var(--border); color:var(--text); padding:6px 12px; border-radius:4px; cursor:pointer; font-size:12px; font-weight:700; width:100%; margin-top:15px;">Logout</button>
  </form>

  <div id="thanksMessage">
    <span class="success-icon">‚úì</span>
    <h2 style="color: #fff; margin: 0 0 10px 0; text-transform: uppercase; font-size: 18px;">Request Received</h2>
    <p style="color: #aaa; margin-bottom: 25px; font-size: 14px; line-height: 1.5;">Our dispatch team has been notified and will review your request shortly.</p>
    <button onclick="location.reload()" type="button" class="success-btn" style="width: 100%; padding: 15px; border-radius: 6px; cursor: pointer; text-transform: uppercase;">Submit Another</button>
  </div>
</div>

<div id="location-picker-modal" class="modal" onclick="if(event.target===this) { this.style.display='none'; document.body.style.overflow=''; }">
<div class="modal-content" style="padding: 0; max-width: 600px; height: 80vh; display: flex; flex-direction: column; overflow: hidden; position: relative;">
<div style="padding: 15px; background: var(--card); border-bottom: 1px solid var(--accent); display: flex; justify-content: space-between; align-items: center;">
<h2 style="color:var(--accent); margin:0; font-size:16px; font-weight:700; text-transform:uppercase;">Pick Location</h2>
<button class="btn-cancel" style="padding: 8px 12px; font-size: 12px; margin:0;" onclick="document.getElementById('location-picker-modal').style.display='none'; document.body.style.overflow='';">CLOSE</button>
</div>
<div style="padding: 10px; background: var(--card); border-bottom: 1px solid var(--border);">
<input type="text" id="loc-search-bar" placeholder="Search address or paste GPS (e.g. 49.852, -99.951)" style="margin:0; width:100%; padding: 10px;">
</div>
<div style="flex: 1; position: relative;">
<div id="picker-map" style="width:100%; height:100%;"></div>
<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); pointer-events: none; font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10;">üìç</div>
</div>
<button class="btn-save" style="width: 100%; border-radius: 0; padding: 16px; font-size: 16px; position: sticky; bottom: 0; z-index: 11;" onclick="setPickerLocation()">SET LOCATION</button>
</div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDltbEbiqlyQjyaGth0AzIkfLpOYr96YeQ&libraries=geometry,drawing,places"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  if (localStorage.getItem('ec_theme') === 'dark') document.body.classList.remove('light-mode');
  else document.body.classList.add('light-mode');
  function toggleTheme() { 
    document.body.classList.toggle('light-mode'); 
    localStorage.setItem('ec_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark'); 
  }

  firebase.initializeApp({
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL),
  apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
    authDomain: "eandccourier-36fcc.firebaseapp.com",
    databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
    projectId: "eandccourier-36fcc",
    messagingSenderId: "1067680083511", 
    appId: "1:1067680083511:android:22d1eb3757302492bd19b2" 
  });

  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);

  firebase.auth().onAuthStateChanged((user) => {
    const portal = document.getElementById('dev-portal');
    const list = document.getElementById('dev-list');

    if (user) {
      if (!user.emailVerified && user.providerData.some(p => p.providerId === 'password')) {
        alert("Please check your email and verify your account before logging in.");
        firebase.auth().signOut();
        return;
      }
      document.getElementById('auth-overlay').style.display = 'none';
      document.getElementById('main-app-container').style.display = 'block';
      if (document.querySelector('input[name="customer_email"]')) {
        document.querySelector('input[name="customer_email"]').value = user.email;
      }
    } else {
      document.getElementById('auth-overlay').style.display = 'flex';
      document.getElementById('main-app-container').style.display = 'none';
    }

    firebase.database().ref('developer').on('value', snap => {
      list.innerHTML = '';
      const notes = snap.val() || {};
      
      Object.values(notes).forEach(note => {
        list.innerHTML += `
          <div class="dev-item">
            <div class="dev-hdr">${note.user} ‚Ä¢ ${note.date}</div>
            <div style="color:#eee;">${note.text}</div>
          </div>`;
      });
      list.scrollTop = list.scrollHeight; 
    });
  });

  function customerLogin() {
    const e = document.getElementById('auth-email').value.trim();
    const p = document.getElementById('auth-password').value.trim();
    if(!e || !p) return alert("Please enter email and password.");
    firebase.auth().signInWithEmailAndPassword(e, p).catch(err => alert("Login Error: " + err.message));
  }

  function customerSignUp() {
    const e = document.getElementById('auth-email').value.trim();
    const p = document.getElementById('auth-password').value.trim();
    if(!e || !p) return alert("Please enter email and password to sign up.");
    firebase.auth().createUserWithEmailAndPassword(e, p).then((cred) => {
      cred.user.sendEmailVerification();
      alert("Account created! We sent a verification link to your email. Please verify before logging in.");
      firebase.auth().signOut();
    }).catch(err => alert("Sign Up Error: " + err.message));
  }

  function googleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider).catch(err => alert("Google Login Error: " + err.message));
  }

  function forgotPassword() {
    const e = document.getElementById('auth-email').value.trim();
    if(!e) return alert("Please enter your email address first, then click Forgot Password.");
    firebase.auth().sendPasswordResetEmail(e).then(() => {
      alert("Password reset email sent. Please check your inbox.");
    }).catch(err => alert("Error: " + err.message));
  }

  const db = firebase.database();
  let driverZones = {};
  db.ref("driver_zones").on("value", s => driverZones = s.val() || {});

  const form = document.getElementById("pickupForm");
  const submitBtn = document.getElementById("submitBtn");

  function formatPhone(input) {
    let x = input.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
    input.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    submitBtn.innerText = "Transmitting...";
    submitBtn.style.opacity = "0.7";
    submitBtn.disabled = true;

    const finalizeSubmission = (coords = {}, assignedDriver = 'Unassigned') => {
        const jobData = {
          name: form.name.value.trim(),
          pickup_location: form.pickup_location.value.trim(),
          pickup_city: form.city.value.trim(),
          city: form.city.value.trim(),
          customer_email: form.customer_email.value.trim(),
          customer_phone: form.customer_phone.value.trim(),
          delivery_name: form.delivery_name.value.trim(),
          destination: form.destination.value.trim(),
          delivery_city: form.drop_city.value.trim(),
          package_details: form.package_details.value.trim(),
          po_number: form.po_number.value.trim() || "",
          other_info: form.other_info.value.trim() ? `[Client Request]: ${form.other_info.value.trim()}` : "[Client Request]",
          status: "pending_pickup",
          type: "pickup",
          assigned_to: assignedDriver, 
          timestamp: Date.now(),
          created_by: firebase.auth().currentUser ? firebase.auth().currentUser.email : "Web Portal",
          ...coords
        };

        db.ref("jobs").push(jobData).then(() => {
          form.style.display = "none";
          document.getElementById("thanksMessage").style.display = "block";
          window.scrollTo({top: 0, behavior: 'smooth'});
        }).catch((error) => {
          submitBtn.innerText = "Submit Request";
          submitBtn.disabled = false;
          submitBtn.style.opacity = "1";
        });
    };

    const geocoder = new google.maps.Geocoder();
    const addressStr = form.pickup_location.value.trim() + ", " + form.city.value.trim();

    // The fix: Set a timeout for the Geocoder. If it takes longer than 3 seconds, submit without coords.
    let geocodeFinished = false;
    const geocodeTimeout = setTimeout(() => {
        if (!geocodeFinished) {
            geocodeFinished = true;
            finalizeSubmission();
        }
    }, 3000);

    geocoder.geocode({ address: addressStr }, (results, status) => {
      if (geocodeFinished) return;
      geocodeFinished = true;
      clearTimeout(geocodeTimeout);

      if (status === "OK" && results[0]) {
        const loc = results[0].geometry.location;
        const coords = { lat: loc.lat(), lng: loc.lng() };
        
        let foundDriver = 'Unassigned';
        for (const [dEmail, zone] of Object.entries(driverZones)) {
          if (zone.polygon) {
            const poly = new google.maps.Polygon({ paths: zone.polygon });
            if (google.maps.geometry.poly.containsLocation(loc, poly)) {
              foundDriver = dEmail;
              break;
            }
          }
        }
        finalizeSubmission(coords, foundDriver);
      } else {
        finalizeSubmission();
      }
    });
  });

  // PWAs & Install logic
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installAppBtn').style.display = 'block';
  });

  document.getElementById('installAppBtn').addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') document.getElementById('installAppBtn').style.display = 'none';
      deferredPrompt = null;
    }
  });

  // Location Picker logic
  let pickerMap, pickerMarker, currentPickerTarget = '';
  function openLocationPicker(target) {
    currentPickerTarget = target;
    const modal = document.getElementById('location-picker-modal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';

    if (!pickerMap) {
      pickerMap = new google.maps.Map(document.getElementById('picker-map'), {
        center: { lat: 49.8951, lng: -97.1384 },
        zoom: 12,
        disableDefaultUI: true,
        zoomControl: true,
        styles: [
          { "featureType": "all", "elementType": "labels.text.fill", "stylers": [{"color": "#ffffff"}] },
          { "featureType": "all", "elementType": "labels.text.stroke", "stylers": [{"color": "#000000"}, {"lightness": 13}] },
          { "featureType": "administrative", "elementType": "geometry.fill", "stylers": [{"color": "#000000"}, {"lightness": 20}] },
          { "featureType": "landscape", "elementType": "geometry", "stylers": [{"color": "#000000"}, {"lightness": 20}] },
          { "featureType": "poi", "elementType": "geometry", "stylers": [{"color": "#000000"}, {"lightness": 21}] },
          { "featureType": "road.highway", "elementType": "geometry.fill", "stylers": [{"color": "#000000"}, {"lightness": 17}] },
          { "featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [{"color": "#000000"}, {"lightness": 29}, {"weight": 0.2}] },
          { "featureType": "road.arterial", "elementType": "geometry", "stylers": [{"color": "#000000"}, {"lightness": 18}] },
          { "featureType": "road.local", "elementType": "geometry", "stylers": [{"color": "#000000"}, {"lightness": 16}] },
          { "featureType": "transit", "elementType": "geometry", "stylers": [{"color": "#000000"}, {"lightness": 19}] },
          { "featureType": "water", "elementType": "geometry", "stylers": [{"color": "#000000"}, {"lightness": 17}] }
        ]
      });

      const searchInput = document.getElementById('loc-search-bar');
      const autocomplete = new google.maps.places.Autocomplete(searchInput);
      autocomplete.bindTo('bounds', pickerMap);
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.geometry) {
          pickerMap.setCenter(place.geometry.location);
          pickerMap.setZoom(17);
        }
      });
      
      searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
              const val = searchInput.value;
              const gps = val.match(/(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/);
              if (gps) {
                  const latLng = { lat: parseFloat(gps[1]), lng: parseFloat(gps[2]) };
                  pickerMap.setCenter(latLng);
                  pickerMap.setZoom(17);
              }
          }
      });
    }
  }

  function setPickerLocation() {
    const center = pickerMap.getCenter();
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: center }, (results, status) => {
      if (status === 'OK' && results[0]) {
        const addr = results[0].formatted_address;
        if (currentPickerTarget === 'pickup') {
          document.getElementById('f-pickup').value = addr;
        } else {
          document.getElementById('f-drop-address').value = addr;
        }
      }
      document.getElementById('location-picker-modal').style.display = 'none';
      document.body.style.overflow = '';
    });
  }
</script>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<button id="devBtn" style="display:block; position:fixed; bottom:20px; right:20px; z-index:10001; background:#111; border:1px solid var(--accent); color:var(--accent); padding:10px 15px; font-size:12px; cursor:pointer; border-radius:4px; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);" onclick="const p=document.getElementById('dev-portal'); p.style.display=(p.style.display==='none'?'flex':'none'); if(p.style.display==='flex' && !devQuill) { devQuill = new Quill('#dev-editor', { theme: 'snow', modules: { toolbar: [ ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }] ] } }); }">DEV NOTES</button>

<div id="dev-portal" style="background:#111; color:#fff; padding:20px; border-top:5px solid var(--accent); display:none; flex-direction:column; gap:15px; position:fixed; bottom:0; left:0; width:100%; box-sizing:border-box; z-index:10000; max-height:80vh; overflow-y:auto;">
  <h3 style="margin:0; text-transform:uppercase; font-size:14px; letter-spacing:1px; color:var(--accent);">Developer Command Center</h3>
  <div id="dev-list" style="max-height: 200px; overflow-y: auto; background:#000; padding:10px; border:1px solid #333; font-size:12px; font-family:monospace;">
    <p style="color:#666;">Authenticating...</p>
  </div>
  <div id="dev-editor" style="min-height: 150px; background:#fff; color:#000;"></div>
  <button onclick="saveDevNote()" style="padding:10px; background:var(--accent); color:#000; border:none; font-weight:800; cursor:pointer;">POST UPDATE</button>
</div>

<style>
  /* Use a fallback if --accent variable isn't defined in your main CSS */
  :root { --accent: #ffd700; } 
  .dev-item { border-bottom:1px solid #222; padding:8px 0; }
  .dev-hdr { color:var(--accent); font-weight:800; margin-bottom:4px; font-size:10px; }
  .ql-toolbar { background: #eee; border: none !important; }
  .ql-container { border: none !important; }
</style>

<script>
  let devQuill;

  // 3. Save Function
  function saveDevNote() {
    const currentUser = firebase.auth().currentUser;
    if (devQuill.getText().trim() === "") return;
    
    const user = currentUser ? currentUser.email.split('@')[0] : "Anonymous";
    const now = new Date();
    const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    firebase.database().ref('developer').push({
      text: devQuill.root.innerHTML,
      user: user,
      date: dateStr,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      devQuill.setText(''); // Reset editor
    }).catch(err => {
      console.error("Command Center Error:", err);
      alert("Post failed. Check database permissions.");
    });
  }
</script>
</body>
</html>
